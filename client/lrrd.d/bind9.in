#!@@PERL@@ -w
#
# Plugin to monitor usage of bind 9 servers
#
# Contributed by Nicolai Langfeldt
#
# $Log$
# Revision 1.1  2004/01/02 15:18:07  jimmyo
# Initial revision
#
# Revision 1.1  2003/12/18 21:45:47  jimmyo
# Plugin contributed by Nicolai Langfeldt
#
#
#%# family=contrib

use strict;

my $QUERYLOG='/usr/bind-chroot/log/query.log';
my $STATEFILE='/opt/lrrd/tmp/bind9.state';
my $OTHER=0;
my %IN;

sub get_state {
    open(Q,"< $STATEFILE") or die;
    while (<Q>) {
        chomp;
        my ($q,$n) = split(/\s+/,$_,2);
        $IN{$q}=$n unless defined($IN{$q});
    }
    close(Q);
}


sub do_stats {
    my $k; 

    open(Q,"< $QUERYLOG") or die;
    while (<Q>) {
	chomp;
	my (undef,undef,undef,undef,undef,undef,undef,$c,$q) = split(/ /,$_,9);
	if ($c eq 'IN') {
	    $IN{$q}++;
        } else {
	    $OTHER++;
        }
    }
    close(Q);

    get_state;

    open(Q,"> $STATEFILE") or die;
    foreach $k (keys %IN) {
	print "query_$k.value ",$IN{$k},"\n";
	print Q "$k ",$IN{$k},"\n";
    }
    close(Q);

    print "query_other.value ",$OTHER,"\n";
}


sub do_config {
    my $k;

    print "graph_title DNS Queries by type
graph_vlabel Queries / minute
query_other.label Other
query_other.type DERIVE
query_other.min 0
query_other.cdef query_other,60,*
";
    get_state;

    foreach $k (keys %IN) {
	print "query_$k.label $k
query_$k.type DERIVE
query_$k.min 0
query_$k.cdef query_$k,60,*
";
    }
};

if (defined($ARGV[0]) and ($ARGV[0] eq 'config')) {
    do_config;
    exit(0);
}

do_stats;


# vim:syntax=perl
