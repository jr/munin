#!@@PERL@@
# -*- perl -*-
#
# Plugin to monitor disk usage. Rewrite based on original shell-based version
# 
# Parameters understood:
#
#       config   (required)
#       autoconf (optional - used by munin-config)
#
# $Log$
#
# Magic markers (optional - used by munin-config and installation
# scripts):
#
#%# family=auto
#%# capabilities=autoconf

use strict;

# IFF anyone is to trunkate labels it's munin-graph.  Label trunkation
# in plugins is the wrong place to put complexity.

# my $MAXLABEL=25;

# Read /proc/mounts
my %mounts;
open (MOUNTS,"/proc/mounts") or die "Could not /proc/mounts for reading.";
while (<MOUNTS>) {
    # Does perl really not have any shorthand for this? I guess it has.
    if ( /^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)/ ) {
	$mounts{$2}=$3;
    }
}
close MOUNTS;

sub print_values() {

    # Read from df
    open (DF,"/bin/df -P -l |") or die "Could not open pipe from /bin/df, $!";
    <DF>; # Skip the header
    while (<DF>) {
	next if /\/\//;
	
	# Parse the output
	if ( /^(\S+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\S+)\s+(\S+)/ ) {
	    my $fs=$mounts{$6};
	    my $ps=$5;
	    my $name=$1;

	    $ps =~ s/\%//;
	    $name =~ s/^\///;
	    $name =~ s/[^A-Za-z0-9_]/_/g;
	    print $name, ".value ", $ps, "\n";
	}
    }
    close DF;
}

if ( $ARGV[0] eq "autoconf" ) {
  if (`perl $0` eq "" ) {
    print "no\n";
    exit 1;
  } else {
    print "yes\n";
    exit 0;
  }
}

if ( $ARGV[0] eq "config" ) {

    # The headers
    print "graph_title Disk usage (in %)\n";
    print "graph_args --upper-limit 100 -l 0\n";
    print "graph_vlabel %\n";
    print "graph_scale no\n";
    print "graph_category disk\n";

    # Read from df
    open (DF,"/bin/df -P -l |") or die "Unable to open pipe from /bin/df";
    <DF>; # Skip the header
    while (<DF>) {
	next if /\/\//;
	
	# Parse the output
	if ( /^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)/ ) {
	    my $fs=$mounts{$6};
	    my $dir=$6;
	    my $name=$1;

	    # Create and print labels
	    $name =~ s/^\///;
	    $name =~ s/[^A-Za-z0-9_]/_/g;
	    print $name,  ".label ", $dir, "\n";

	    # FIXME: These ought to be tunable
	    print "$name.warning 92\n";
	    print "$name.critical 98\n";
	}
    }
    close DF;
    exit 0;
}

print_values();
