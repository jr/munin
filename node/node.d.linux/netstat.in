#!/bin/sh
#
# Plugin to monitor network connections.
#
# Parameters:
#
# 	config   (required)
# 	autoconf (optional - only used by munin-config)
#
# $Log$
# Revision 1.4  2004/11/21 00:17:12  jimmyo
# Changed a lot of plugins so they use DERIVE instead of COUNTER.
#
# Revision 1.3  2004/09/25 22:29:16  jimmyo
# Added info fields to a bunch of plugins.
#
# Revision 1.2  2004/05/20 13:57:12  jimmyo
# Set categories to some of the plugins.
#
# Revision 1.1  2004/01/29 19:21:20  jimmyo
# Moved generic netstat to linux-dir, as it is too spesific. Added Solaris version of the plugin as well. (SF#882354)
#
# Revision 1.1  2004/01/02 18:50:00  jimmyo
# Renamed occurrances of lrrd -> munin
#
# Revision 1.1.1.1  2004/01/02 15:18:07  jimmyo
# Import of LRRD CVS tree after renaming to Munin
#
# Revision 1.2  2003/11/07 17:43:16  jimmyo
# Cleanups and log entries
#
#
#
# Magic markers (optional - used by munin-config and some installation
# scripts):
#%# family=auto
#%# capabilities=autoconf



if [ "$1" = "autoconf" ]; then
	if ( netstat -s 2>/dev/null >/dev/null ); then
		echo yes
		exit 0
	else
		if [ $? -eq 127 ]
		then
			echo "no (netstat program not found)"
			exit 1
		else
			echo no
			exit 1
		fi
	fi
fi

if [ "$1" = "config" ]; then

	echo 'graph_title Netstat'
	echo 'graph_args -l 0 --base 1000'
	echo 'graph_vlabel active connections'
	echo 'graph_category network'
	echo 'graph_info This graph shows the TCP activity of all the network interfaces combined.'
	echo 'active.label active'
	echo 'active.type DERIVE'
	echo 'active.max 50000'
	echo 'active.min 0'
	echo 'active.info The number of active TCP openings per second.'
	echo 'passive.label passive'
	echo 'passive.type DERIVE'
	echo 'passive.max 50000'
	echo 'passive.min 0'
	echo 'passive.info The number of passive TCP openings per second.'
	echo 'failed.label failed'
	echo 'failed.type DERIVE'
	echo 'failed.max 50000'
	echo 'failed.min 0'
	echo 'failed.info The number of failed TCP connection attempts per second.'
	echo 'resets.label resets'
	echo 'resets.type DERIVE'
	echo 'resets.max 50000'
	echo 'resets.min 0'
	echo 'resets.info The number of TCP connection resets.'
	echo 'established.label established'
	echo 'established.type GAUGE'
	echo 'established.max 50000'
	echo 'established.info The number of currently open connections.'
	exit 0
fi

netstat -s | awk '/active connections/ { print "active.value " $1 } /passive connection/ { print "passive.value " $1 } /failed connection/ { print "failed.value " $1 } /connection resets/ { print "resets.value " $1 } /connections established/ { print "established.value " $1 }'

