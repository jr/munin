#!/bin/sh
#
# Plugin to monitor sendmail statistics.
#
# Usage: Place in /etc/lrrd/client.d/ (or link it there  using ln -s)
#
# Parameters understood:
#
# 	config   (required)
# 	autoconf (optional)
#
# $Log$
# Revision 1.3  2004/11/10 15:49:05  jimmyo
# Fixed typo in generic/sendmail_mailstats (patch by Lupe Christoph, SF#1058128).
#
# Revision 1.2  2004/05/20 19:02:36  jimmyo
# Set categories on a bunch of plugins
#
# Revision 1.1  2004/02/18 18:40:03  jimmyo
# Added Log:
#
#

TEMP_FILE=/tmp/lrrd-sendmail

if [ "$1" = "autoconf" ]; then
        if which mailstats 2>&1 > /dev/null ; then
		echo yes
		exit 0
	else
		echo no
		exit 1
	fi
fi

if [ "$1" = "config" ]; then

	echo 'graph_title Sendmail email traffic'
	echo 'graph_order received sent rejected discarded'
	echo 'graph_vlabel mails'
	echo 'graph_category sendmail'
	echo 'received.label received'
	echo 'sent.label sent'
	echo 'rejected.label rejected'
	echo 'discarded.label discarded'
	exit 0
fi

mailstats -p > ${TEMP_FILE}
received=0 ; sent=0 ; rejected=0 ; discarded=0
grep '^ *T' ${TEMP_FILE} | \
(
while read line ; do
  set -- ${line}
  received=`expr ${received} + $4`
  sent=`expr ${sent} + $2`
  rejected=`expr ${rejected} + $6`
  discarded=`expr ${discarded} + $7`
done 

echo "received.value ${received}"
echo "sent.value ${sent}"
echo "rejected.value ${rejected}"
echo "discarded.value ${discarded}"
)
