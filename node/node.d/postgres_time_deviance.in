#!@@PERL@@ -w
# -*- perl -*-

# Compare server time with postgresql time-keeping and show
# difference.
#
#%# family=manual

use strict;
use DBI;

my $dbhost = $ENV{'dbhost'} || '127.0.0.1';
my $dbport = $ENV{'dbport'} || '5432';
my $dbname = $ENV{'dbname'} || 'template1';
my $dbuser = $ENV{'dbuser'} || 'postgres';

if ($ARGV[0] && $ARGV[0] eq 'config') {
    print <<EOF;
graph_title Postgres time deviance
graph_args --base 1000
graph_vlabel seconds (+ ahead / - behind)
graph_category Postgresql
graph_info Shows Postgres time compared to system time
time_diff.label Seconds
time_diff.info Seconds deviance from system time
time_diff.type GAUGE
time_diff.warning -1:1
time_diff.critical -10:10
EOF
} else {
    my $Con = "DBI:Pg:dbname=$dbname;host=$dbhost;port=$dbport";
    my $Dbh = DBI->connect ($Con, $dbuser,'',
			    {RaiseError =>1}) || 
       die "Unable to access Database $dbname on host $dbhost as user $dbuser.\nError returned was: ". $DBI::errstr;
    my $sql = "SELECT date_part('epoch', now()) AS unixtime;";
    my $sth = $Dbh->prepare($sql);
    $sth->execute();
    my ($time, $version) = $sth->fetchrow();
    my $diff = time() - $time;
    print "time_diff.value $diff\n";
}
