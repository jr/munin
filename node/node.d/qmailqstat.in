#!@@GOODSH@@
#
# Plugin to show the amount of messages in the qmail queue
#
# Based on the qmailqueue plugin contributed by David Obando (david@cryptix.de) - 23.11.2005
# Modified by Nils Breunese <nils@lemonbit.nl> - Sun Mar 16 2008
#
# Magic markers - optional - used by installation scripts and munin-config:
#
# Configuration:
#  [qmailstat]
#      env.qmailstat /usr/bin/qmail-qstat
#
#
#%# family=auto
#%# capabilities=autoconf

QMAILQSTAT=/var/qmail/bin/qmail-qstat
if [ "$qmailqstat" ]; then QMAILSTAT=$qmailqstat ; fi

if [ "$1" = "autoconf" ]; then
	if [ -f ${QMAILQSTAT} ] ; then
		echo yes
		exit 0
	else
		echo no
		exit 1
	fi
fi

if [ "$1" = "config" ]; then
	echo 'graph_title Qmail queue'
	echo 'graph_args --base 1000 -l 0'
	echo 'graph_vlabel messages'
	echo 'graph_category Mail'
	echo 'graph_order total notpreprocessed'
	echo 'total.label Total messages in queue'
	echo 'total.min 0'
	echo 'total.draw AREA'
	echo 'total.warning 100'
	echo 'total.critical 1000'
	echo 'notpreprocessed.label Not yet preprocessed'
	echo 'notpreprocessed.min 0'
	echo 'notpreprocessed.draw LINE2'
	exit 0
fi

echo -n "total.value "           && $QMAILQSTAT | grep -v proc | awk '{print $NF}'
echo -n "notpreprocessed.value " && $QMAILQSTAT | grep proc    | awk '{print $NF}'
