#!/bin/sh
# 
# Plugin to monitor the number of slow queries on a mysql-server
#
# Parameters:
# 	
# 	configure
# 	autoconf
#
# Configuration variables
#
#	mysqlopts     - Options to pass to mysql
#
# $Log$
# Revision 1.6  2004/12/10 10:47:47  jimmyo
# Change name from ${scale} to ${graph_period}, to be more consistent.
#
# Revision 1.5  2004/12/09 22:12:55  jimmyo
# Added "graph_period" option, to make "graph_sums" usable.
#
# Revision 1.4  2004/11/21 00:16:56  jimmyo
# Changed a lot of plugins so they use DERIVE instead of COUNTER.
#
# Revision 1.3  2004/05/20 13:57:12  jimmyo
# Set categories to some of the plugins.
#
# Revision 1.2  2004/04/27 18:58:53  jimmyo
# Fixed bug in mysql-plugins (Deb#233762).
#
# Revision 1.1  2004/01/02 18:50:00  jimmyo
# Renamed occurrances of lrrd -> munin
#
# Revision 1.1.1.1  2004/01/02 15:18:07  jimmyo
# Import of LRRD CVS tree after renaming to Munin
#
# Revision 1.6  2003/11/07 17:43:16  jimmyo
# Cleanups and log entries
#
#
#
#%# family=auto
#%# capabilities=autoconf

MYSQLOPTS="$mysqlopts"
MYSQLADMIN=${mysqladmin:-mysqladmin}

if [ "$1" = "autoconf" ]; then
        $MYSQLADMIN --version 2>/dev/null >/dev/null
        if [ $? -eq 0 ]
        then
                $MYSQLADMIN $MYSQLOPTS status 2>/dev/null >/dev/null
                if [ $? -eq 0 ]
                then
                        echo yes
                        exit 0
                else
                        echo "no (could not connect to mysql)"
                fi
        else
                echo "no (mysqladmin not found)"
        fi
        exit 1
fi

if [ "$1" = "config" ]; then
	echo 'graph_title MySQL slow queries'
	echo 'graph_args --base 1000 -l 0'
	echo 'graph_vlabel slow queries / ${graph_period}'
	echo 'graph_category mysql'
	echo 'queries.label slow queries'
	echo 'queries.type DERIVE'
	echo 'queries.min 0'
	echo 'queries.max 500000'
	exit 0
fi

/usr/bin/printf "queries.value "
($MYSQLADMIN $MYSQLOPTS status 2>/dev/null || echo a a a a a a a a U) | awk '{print $9}'
