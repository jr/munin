#!/bin/sh
#
# Plugin to monitor CPU usage.
#
# Usage: Place in /etc/munin/node.d/ (or link it there  using ln -s)
#
# Parameters understood:
#
# 	config   (required)
# 	autoconf (optional - used by munin-config)
#
# $Log$
# Revision 1.3  2004/04/30 16:43:00  jimmyo
# Cleaned up Solaris plugins.
#
# Revision 1.2  2004/02/18 16:39:37  jimmyo
# Turned off scaling of values for cpu-graphs (no more nano-percentages).
#
# Revision 1.1  2004/01/02 18:50:01  jimmyo
# Renamed occurrances of lrrd -> munin
#
# Revision 1.1.1.1  2004/01/02 15:18:07  jimmyo
# Import of LRRD CVS tree after renaming to Munin
#
# Revision 1.5  2003/11/07 22:12:51  jimmyo
# Changed deprecated plugin options
#
# Revision 1.4  2003/11/07 17:43:16  jimmyo
# Cleanups and log entries
#
#
#
# Magic markers - optional - used by installation scripts and
# munin-config:
#
#%# family=auto
#%# capabilities=autoconf

if [ "$1" = "autoconf" ]; then
	if [ -x /usr/bin/kstat ]; then
		echo yes
		exit 0
	else
		echo no
		exit 1
	fi
fi

if [ "$1" = "config" ]; then
	echo 'graph_title CPU usage'
	echo 'graph_order system user waitio idle'
	cpumax=`expr \`kstat -p -c misc -s '/^ncpus$/' | cut -f2 -d'	'\` '*' 100`
	echo "graph_args --base 1000 --lower-limit 0 --rigid --upper-limit $cpumax"
	echo 'graph_vlabel %'
	echo 'graph_scale no'
	echo 'system.label system'
	echo 'system.draw AREA'
	echo 'system.type COUNTER'
	echo "system.max $cpumax"
	echo 'user.label user'
	echo 'user.draw STACK'
	echo 'user.type COUNTER'
	echo "user.max $cpumax"
	echo "waitio.max $cpumax"
	echo 'waitio.label waitio'
	echo 'waitio.draw STACK'
	echo 'waitio.type COUNTER'
	echo 'idle.label idle'
	echo 'idle.draw STACK'
	echo 'idle.type COUNTER'
	echo "idle.max $cpumax"
	exit 0
fi

kstat -p -c misc -m cpu_stat -s '/^(user|kernel|wait|idle)$/' | sed -e 's/.*://' | awk '
BEGIN {
	map["user"] = "user"
	map["kernel"] = "system"
	map["wait"] = "waitio"
	map["idle"] = "idle"
}
length(map[$1]) > 0 {
	sum[map[$1]] += $2
	total += $2
}
END {
	for (item in sum) {
		print item ".value", sum[item]
	}
}'
